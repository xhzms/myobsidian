#!/bin/bash
# chmod +x run.sh ë¡œ ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬ í›„ ì‚¬ìš©
# Brand Extraction - Full Pipeline
# ì›¹ì‚¬ì´íŠ¸ì—ì„œ ë¸Œëœë“œ ìì‚° ì¶”ì¶œ + ë¶„ë¥˜ ìë™ ì‹¤í–‰

set -e

# ìƒ‰ìƒ ì •ì˜
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# ì‚¬ìš©ë²•
usage() {
    echo "ì‚¬ìš©ë²•: $0 --url <URL> --name <ë¸Œëœë“œëª…> [--depth <ê¹Šì´>]"
    echo ""
    echo "ì˜µì…˜:"
    echo "  --url     í¬ë¡¤ë§í•  ì›¹ì‚¬ì´íŠ¸ URL (í•„ìˆ˜)"
    echo "  --name    ë¸Œëœë“œëª…/í”„ë¡œì íŠ¸ëª… (í•„ìˆ˜)"
    echo "  --depth   í¬ë¡¤ë§ ê¹Šì´ (ê¸°ë³¸: 2)"
    echo ""
    echo "ì˜ˆì‹œ:"
    echo "  $0 --url https://example.com --name example-brand"
    exit 1
}

# ì¸ì íŒŒì‹±
URL=""
NAME=""
DEPTH=2

while [[ $# -gt 0 ]]; do
    case $1 in
        --url)
            URL="$2"
            shift 2
            ;;
        --name)
            NAME="$2"
            shift 2
            ;;
        --depth)
            DEPTH="$2"
            shift 2
            ;;
        *)
            usage
            ;;
    esac
done

# í•„ìˆ˜ ì¸ì í™•ì¸
if [ -z "$URL" ] || [ -z "$NAME" ]; then
    usage
fi

# ê²½ë¡œ ì„¤ì •
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
OUTPUT_DIR="$SCRIPT_DIR/../output/$NAME"

echo -e "${GREEN}"
echo "============================================================"
echo "ğŸš€ Brand Extraction Pipeline"
echo "============================================================"
echo -e "${NC}"
echo "URL:    $URL"
echo "Brand:  $NAME"
echo "Depth:  $DEPTH"
echo "Output: $OUTPUT_DIR"
echo ""

# ì˜ì¡´ì„± í™•ì¸
echo -e "${YELLOW}ğŸ“¦ ì˜ì¡´ì„± í™•ì¸...${NC}"
pip install -q -r "$SCRIPT_DIR/requirements.txt"

# Step 1: í¬ë¡¤ë§
echo -e "\n${YELLOW}[Step 1/3] ì›¹ì‚¬ì´íŠ¸ í¬ë¡¤ë§...${NC}"
python3 "$SCRIPT_DIR/crawler.py" \
    --url "$URL" \
    --output "$OUTPUT_DIR" \
    --depth "$DEPTH"

# Step 2: ì´ë¯¸ì§€ ë¶„ë¥˜
echo -e "\n${YELLOW}[Step 2/3] ì´ë¯¸ì§€ ë¶„ë¥˜...${NC}"
python3 "$SCRIPT_DIR/classifier.py" \
    --input "$OUTPUT_DIR/raw/images" \
    --output "$OUTPUT_DIR/classified" \
    --metadata "$OUTPUT_DIR/data/images.json"

# Step 3: ë¦¬í¬íŠ¸ ìƒì„±
echo -e "\n${YELLOW}[Step 3/3] ë¦¬í¬íŠ¸ ìƒì„±...${NC}"

REPORT_PATH="$OUTPUT_DIR/brand-report.md"
PAGES_COUNT=$(cat "$OUTPUT_DIR/data/pages.json" | python3 -c "import sys, json; print(len(json.load(sys.stdin)))" 2>/dev/null || echo "0")
IMAGES_COUNT=$(cat "$OUTPUT_DIR/data/images.json" | python3 -c "import sys, json; print(len(json.load(sys.stdin)))" 2>/dev/null || echo "0")
COLORS_COUNT=$(cat "$OUTPUT_DIR/data/colors.json" | python3 -c "import sys, json; print(len(json.load(sys.stdin)))" 2>/dev/null || echo "0")
FONTS_COUNT=$(cat "$OUTPUT_DIR/data/fonts.json" | python3 -c "import sys, json; print(len(json.load(sys.stdin)))" 2>/dev/null || echo "0")

cat > "$REPORT_PATH" << EOF
# Brand Extraction Report: $NAME

**ì†ŒìŠ¤**: $URL  
**ì¶”ì¶œì¼**: $(date '+%Y-%m-%d %H:%M')

## ìš”ì•½

| í•­ëª© | ìˆ˜ëŸ‰ |
|------|------|
| í¬ë¡¤ë§ í˜ì´ì§€ | $PAGES_COUNT |
| ì¶”ì¶œ ì´ë¯¸ì§€ | $IMAGES_COUNT |
| ìƒ‰ìƒ | $COLORS_COUNT |
| í°íŠ¸ | $FONTS_COUNT |

## í´ë” êµ¬ì¡°

\`\`\`
$NAME/
â”œâ”€â”€ raw/images/          # ì›ë³¸ ì´ë¯¸ì§€
â”œâ”€â”€ classified/          # ë¶„ë¥˜ëœ ì´ë¯¸ì§€
â”‚   â”œâ”€â”€ hero/
â”‚   â”œâ”€â”€ product/
â”‚   â”œâ”€â”€ icon/
â”‚   â”œâ”€â”€ person/
â”‚   â”œâ”€â”€ background/
â”‚   â”œâ”€â”€ social/
â”‚   â””â”€â”€ misc/
â”œâ”€â”€ data/
â”‚   â”œâ”€â”€ pages.json
â”‚   â”œâ”€â”€ images.json
â”‚   â”œâ”€â”€ colors.json
â”‚   â””â”€â”€ fonts.json
â””â”€â”€ brand-report.md
\`\`\`

## ë‹¤ìŒ ë‹¨ê³„

1. \`classified/\` í´ë”ì—ì„œ ì´ë¯¸ì§€ í™•ì¸ ë° ìˆ˜ë™ ì¬ë¶„ë¥˜
2. \`data/colors.json\`ì—ì„œ ë¸Œëœë“œ ì»¬ëŸ¬ í™•ì¸
3. \`data/fonts.json\`ì—ì„œ ì‚¬ìš© í°íŠ¸ í™•ì¸
4. í•„ìš”í•œ ìì‚°ì„ í”„ë¡œì íŠ¸ í´ë”ë¡œ ì´ë™

---
*Generated by Brand Extraction Skill*
EOF

echo -e "\n${GREEN}"
echo "============================================================"
echo "âœ… ì™„ë£Œ!"
echo "============================================================"
echo -e "${NC}"
echo "ğŸ“ ê²°ê³¼: $OUTPUT_DIR"
echo "ğŸ“„ ë¦¬í¬íŠ¸: $REPORT_PATH"
echo ""
echo "ë‹¤ìŒ ë‹¨ê³„:"
echo "  1. $OUTPUT_DIR/classified/ ì—ì„œ ë¶„ë¥˜ëœ ì´ë¯¸ì§€ í™•ì¸"
echo "  2. í•„ìš” ì‹œ ìˆ˜ë™ìœ¼ë¡œ ì´ë¯¸ì§€ ì¬ë¶„ë¥˜"
echo "  3. í”„ë¡œì íŠ¸ ì„¸íŒ…ìœ¼ë¡œ ì´ë™ (01_project-setup)"
